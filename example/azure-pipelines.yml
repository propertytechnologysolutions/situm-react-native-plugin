# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger: none

pr: none

parameters:
  - name: system
    type: string
    values:
      - "ubuntu-latest"
      - "macOS-11"

resources:
  repositories:
  - repository: sys_kubernetes_templates
    type: bitbucket
    endpoint: Bitbucket - sistemas
    name: situm/sys-kubernetes-templates.git

jobs: 
- job:
  displayName: Build ${{ parameters.system }}
  pool:
    vmImage: ${{ parameters.system }}
  steps:
  - checkout: self
    fetchDepth: 1
    fetchTags: false
    displayName: Clone repository

  - bash: |

      echo -e "\n[+] Install plugin dependencies\n"
      npm install

      echo -e "\n[+] Install example dependencies\n"
      cd example
      npm install

    displayName: Install plugin dependencies
  
  - ${{ if contains(parameters.system, 'macOS') }}:

    - task: DownloadSecureFile@1
      name: api_key
      inputs:
        secureFile: api_key.json

    - bash: |
        echo -e "\n[+] Install iOS example dependencies\n"
        cd example/ios
        pod install
      displayName: Install iOS example dependencies

    - bash: |

        cd example/ios/fastlane

        echo -e "\n[+] Setting Apple connection options"

        cp $(api_key.secureFilePath) .
        export appleID=$(appleID) 

        echo -e "\n[+] Install fastlane \n"
        gem install fastlane

        echo -e "\n[+] Build example with fastlane \n"
        fastlane ios beta

      displayName: Build iOS example 
  
  
  - ${{ if contains(parameters.system, 'ubuntu') }}:

    - template: azure-templates/upload-sharepoint.yml@sys_kubernetes_templates
      parameters:
        prepare_ndk: false
        sharepoint_folder: "/Documentos%20compartidos/Desarrollo/Apks/RNSDK"
  
    - bash: |
 
        echo -e "\n[+] Build Android example \n"
        cd example/android

        ./gradlew assembleDebug
        
      displayName: Build Android dependencies


    - bash: |
        folder="/Documentos%20compartidos/Desarrollo/Apks/RNSDK"
        echo -e "\n[+] Create folder to APK"

        o365 spo folder add -p $folder -u https://sistemassitum.sharepoint.com/sites/producteng --name $(Build.BuildNumber)

        echo -e "\n[+] Upload APK \n"
        cd app/build/outputs/apk/debug
        o365 spo file add -p app-debug.apk -u https://sistemassitum.sharepoint.com/sites/producteng -f $folder/$(Build.BuildNumber)

      displayName: Upload APK
